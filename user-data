#cloud-config

# This is the user-data configuration file for cloud-init.
# https://cloudinit.readthedocs.io/

## Set hostname and timezone
hostname: <HOSTNAME> # pi-k8s
timezone: <TIMEZONE> # CET

## Enable password authentication with the SSH daemon
ssh_pwauth: true

## Add users and groups to the system, and import keys with 
## the ssh-import-id utility
users:
- name: <USERNAME> # piuser
  primary-group: users
  shell: /bin/bash
  sudo: ALL=(ALL) NOPASSWD:ALL
  passwd: <PASSWORD> # SHA-512
  groups: ubuntu,adm,dialout,cdrom,floppy,sudo,audio,dip,video,plugdev,netdev,lxd
  lock_passwd: true
  ssh-authorized-keys:
    - <SSH-PUBKEY> # ssh-ed25519 ABC piuser@pi-k8s

## Update apt database and upgrade packages on first boot
package_update: true
package_upgrade: true

# Configure ssh, cgroup, firewall and install k3s
runcmd:
  - sed -i -e '/^\(#\|\)PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)PasswordAuthentication/s/^.*$/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)X11Forwarding/s/^.*$/X11Forwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowTcpForwarding/s/^.*$/AllowTcpForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowAgentForwarding/s/^.*$/AllowAgentForwarding no/' /etc/ssh/sshd_config
  - sed -i -e 's/$/ cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory/' /boot/firmware/cmdline.txt
  - curl -sfL https://get.k3s.io | sh -
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow in 22
  - ufw allow in 80
  - ufw allow in 443
  - ufw enable
  - reboot